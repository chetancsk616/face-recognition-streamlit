<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Offline Face Detection (OpenCV.js DNN)</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f2f2f2; }
    #canvasOutput { margin-top: 20px; border-radius: 10px; }
    #upload { margin-top: 20px; }
  </style>
</head>
<body>
  <h2>Offline Face Detection using OpenCV.js (DNN)</h2>
  <input type="file" id="upload" accept="image/*">
  <canvas id="canvasOutput"></canvas>

  <script async src="opencv.js" onload="onOpenCvReady();"></script>
  <script>
    let net;

    async function onOpenCvReady() {
      console.log("OpenCV.js loaded");
      // Load model files locally
      const prototxt = await fetch('deploy.prototxt').then(r => r.arrayBuffer());
      const model = await fetch('res10_300x300_ssd_iter_140000.caffemodel').then(r => r.arrayBuffer());

      net = cv.readNetFromCaffe(
        new Uint8Array(prototxt),
        new Uint8Array(model)
      );
      console.log("Model loaded!");
    }

    document.getElementById('upload').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const img = new Image();
      img.src = URL.createObjectURL(file);
      img.onload = () => detectFace(img);
    });

    function detectFace(imgElement) {
      if (!net) {
        alert("Model not yet loaded!");
        return;
      }

      const mat = cv.imread(imgElement);
      const blob = cv.blobFromImage(mat, 1.0, new cv.Size(300, 300),
                  new cv.Scalar(104, 177, 123), false, false);
      net.setInput(blob);
      const detections = net.forward();

      const cols = mat.cols;
      const rows = mat.rows;
      for (let i = 0; i < detections.size[2]; i++) {
        const confidence = detections.data32F[i * 7 + 2];
        if (confidence > 0.5) {
          const x1 = detections.data32F[i * 7 + 3] * cols;
          const y1 = detections.data32F[i * 7 + 4] * rows;
          const x2 = detections.data32F[i * 7 + 5] * cols;
          const y2 = detections.data32F[i * 7 + 6] * rows;
          cv.rectangle(mat, new cv.Point(x1, y1), new cv.Point(x2, y2), [0, 255, 0, 255], 2);
        }
      }

      cv.imshow("canvasOutput", mat);
      mat.delete();
      blob.delete();
      detections.delete();
    }
  </script>
</body>
</html>
